# Movies Scrapy Parser (Wikipedia → CSV + IMDb rating). Храмова Ольга 

Домашнее задание номер 5 с scrapy-парсером, который собирает информацию о фильмах из категорий русской Википедии и сохраняет результат в CSV.

## Функционал парсера
Парсер собирает по каждому фильму поля:

- **Название** (`title`)
- **Жанр** (`genre`)
- **Режиссёр** (`director`)
- **Страна** (`country`)
- **Год** (`year`)
- **Рейтинг IMDb** (`imdb_rating`) — *доп. задание* (если на странице Википедии есть ссылка на IMDb)

Результаты сохраняются в **CSV** с кодировкой `utf-8-sig`.

---

## Источники данных (откуда парсим)
### 1) Wikipedia (RU) — основная база фильмов
Парсер стартует с 2 категорий Википедии:

- Категория: **Фильмы по алфавиту**
  - https://ru.wikipedia.org/wiki/Категория:Фильмы_по_алфавиту
- Категория: **Фильмы по годам**
  - https://ru.wikipedia.org/wiki/Категория:Фильмы_по_годам

Из страниц категорий парсер:
- забирает ссылки на страницы фильмов (статьи),
- рекурсивно обходит подкатегории (актуально для “по годам”),
- переходит по “Следующая страница” в категории (пагинация),
- останавливается по лимиту `max_movies`, чтобы не парсить бесконечно.

### 2) IMDb — дополнительный рейтинг
Если на странице фильма в Википедии найдена ссылка вида:
`https://www.imdb.com/title/ttXXXXXXX/`  
парсер дополнительно идёт на IMDb и вытаскивает **ratingValue** (рейтинг) из JSON-LD или из DOM (fallback).

---

## Как ведётся парсинг. Алгоритм

### A. Входные страницы (start_urls)
1) Spider открывает стартовые страницы категорий Википедии (`start_urls`).
2) На каждой категории он ищет:
   - блок **подкатегорий** (`#mw-subcategories`) → заходит внутрь рекурсивно,
   - блок **страниц** (`#mw-pages`) → находит ссылки на статьи,
   - ссылку **"Следующая страница"** → пагинация категории.

### B. Сбор ссылок на фильмы
3) Из `#mw-pages` берутся ссылки на статьи (`/wiki/...`).
4) Отсекаются служебные страницы:
   - ссылки с двоеточием в названии (например `Special:`, `Категория:`),
   - не-статьи и системные разделы.

### C. Парсинг страницы фильма
5) Для каждой страницы фильма spider открывает статью и пытается достать данные из инфобокса:
   - `Жанр / Жанры`
   - `Режиссёр / Режиссер / Режиссёр-постановщик`
   - `Страна / Страны`
   - `Год / Дата выхода / Премьера`
6) Год приводится к виду `YYYY` (первое найденное 4-значное число года).

### D. IMDb (доп. задание)
7) Если на странице Википедии найден IMDb `tt-id`, spider делает запрос на IMDb:
   - сначала пытается вытащить `ratingValue` из JSON-LD,
   - если не получилось — пробует DOM-селектор (fallback).
8) Рейтинг добавляется в поле `imdb_rating`. Если ссылки на IMDb нет — поле остаётся пустым.

### E. Экспорт в CSV
9) Scrapy FEED Exporter сохраняет items в CSV:
- по умолчанию: `movies.csv`
- порядок полей фиксирован: `title, genre, director, country, year, imdb_rating`

___

## Настройки Scrapy (settings.py) — что поменяли относительно дефолтных

В проекте были изменены/добавлены следующие настройки (по сравнению со стандартным шаблоном `scrapy startproject`):

### 1) Экспорт CSV и кодировка
Чтобы итоговый CSV корректно открывался в Excel и сохранял кириллицу:
- `FEED_EXPORT_ENCODING = "utf-8-sig"` — экспорт в UTF-8 с BOM

### 2) User-Agent (устойчивость к блокировкам)
Заменён `USER_AGENT` на значение браузера.
Это снижает шанс получить ограничения со стороны сайтов и делает запросы более “похожими” на запросы реального пользователя.

### 3) Ограничение скорости и авто-троттлинг (вежливый парсинг)
Изменены настройки, чтобы не перегружать сайты и уменьшить шанс бана:
- `DOWNLOAD_DELAY = 1.0` — задержка между запросами
- `CONCURRENT_REQUESTS_PER_DOMAIN = 2` — ограничение параллельных запросов к одному домену
- `AUTOTHROTTLE_ENABLED = True` — Scrapy сам регулирует скорость при нагрузке/ответах сервера

### 4) ROBOTSTXT_OBEY
- `ROBOTSTXT_OBEY = False`
Сняли ограничение Scrapy на обход страниц.

___

## Примеры полученных данных 

Фрагмент итогового `movies.csv`:

> Колонки: `country, director, genre, imdb_rating, title, year`

| country                     | director              | genre                                              | imdb_rating | title | year |
|----------------------------|-----------------------|---------------------------------------------------|------------|-------|------|
| Республика Корея           | Кан Джегю             | драма, боевик, военный                            | 8          |       | 2004 |
| Гонконг                    | Чэнь Чжихуа           | боевик, комедия                                   | 7          |       | 1977 |
| СССР                       | Андрей Малюков        | Фильм-катастрофа, приключенческий фильм, драма    | 3          |       | 1981 |
| США, Чили, Колумбия        | Патрисия Ригген       | драма                                             | 7          |       | 2015 |
| Канада                     | Дени Вильнёв          | драма, мелодрама                                  | 6          |       | 1998 |
| Россия                     | Александр Муратов     | комедия, фантастика, мелодрама                    | 4.9        |       | 2004 |
| Мексика, Испания           | Ригоберто Кастаньеда  | ужасы, мистика                                    | 6          |       | 2006 |
| СССР                       | Леонид Квинихидзе     | музыкальный фильм, мюзикл, фэнтези                | 9          |       | 1978 |
| США                        | Роб Зомби             | Фильм ужасов                                      | 5          |       | 2016 |
| Россия                     | Таисия Игуменцева     | комедия, мелодрама                                | 6          |       | 2016 |
| США                        | Крэйг Мосс            | комедийный, фильм ужасов                          | 2          |       | 2012 |
| США                        | Дэвид Слейд           | фильм о вампирах                                  | 7          |       | 2007 |
| Швеция                     | Андерс Банке          | фильм ужасов, комедия                             | 8          |       | 2006 |

Пояснения:
- `imdb_rating` заполняется, если в статье Википедии найдена ссылка на IMDb и рейтинг удалось извлечь.
- `genre` может содержать несколько значений через запятую.

